<!--miniprogram/pages/station-detail/station-detail.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ - ç«™ç‚¹ä¿¡æ¯å¡ç‰‡ -->
  <view class="station-header">
    <view class="station-info">
      <view class="station-title">
        <text class="station-name">{{stationInfo.name}}</text>
        <text class="station-id">ID: {{stationInfo.stationId}}</text>
      </view>
      <view class="station-stats">
        <text class="avg-demand">å¹³å‡éœ€æ±‚: {{stationInfo.avgDemand}}æ¬¡/å°æ—¶</text>
      </view>
    </view>
    <view class="action-buttons">
      <button class="btn-favorite {{isFavorite ? 'active' : ''}}" bindtap="toggleFavorite">
        <text class="icon">{{isFavorite ? 'â˜…' : 'â˜†'}}</text>
        <text>{{isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
      </button>
      <button class="btn-share" open-type="share">
        <text class="icon">ğŸ“¤</text>
        <text>åˆ†äº«</text>
      </button>
    </view>
  </view>

  <!-- ç«™ç‚¹é€‰æ‹©å™¨ -->
  <view class="station-selector">
    <view class="selector-title">é€‰æ‹©ç«™ç‚¹</view>
    <picker mode="selector" range="{{stationList}}" range-key="name" value="{{stationIndex}}" bindchange="onStationChange">
      <view class="selector-picker">
        <text>{{currentStationName}}</text>
        <text class="picker-icon">â–¼</text>
      </view>
    </picker>
  </view>

  <!-- æ—¥æœŸé€‰æ‹©åŒºåŸŸ -->
  <view class="date-selector">
    <view class="date-title">æŸ¥è¯¢æ—¶é—´èŒƒå›´</view>
    <view class="date-range">
      <picker mode="date" value="{{startDate}}" start="2021-05-01" end="2021-05-31" bindchange="onStartDateChange">
        <view class="date-picker">
          <text>{{startDate}}</text>
          <text class="picker-icon">ğŸ“…</text>
        </view>
      </picker>
      <text class="date-separator">è‡³</text>
      <picker mode="date" value="{{endDate}}" start="{{startDate}}" end="2021-05-31" bindchange="onEndDateChange">
        <view class="date-picker">
          <text>{{endDate}}</text>
          <text class="picker-icon">ğŸ“…</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- Tabåˆ‡æ¢ -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 'chart' ? 'active' : ''}}" bindtap="switchTab" data-tab="chart">
      <text>ğŸ“Š å›¾è¡¨</text>
    </view>
    <view class="tab-item {{currentTab === 'stats' ? 'active' : ''}}" bindtap="switchTab" data-tab="stats">
      <text>ğŸ“ˆ ç»Ÿè®¡</text>
    </view>
    <view class="tab-item {{currentTab === 'table' ? 'active' : ''}}" bindtap="switchTab" data-tab="table">
      <text>ğŸ“‹ æ•°æ®</text>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-area" style="width: 100%;">
    <!-- è¶‹åŠ¿å›¾æ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'chart'}}">
      <!-- å›¾è¡¨ç±»å‹é€‰æ‹© - å…³é”®ï¼šæ”¹ç”¨viewè€Œä¸æ˜¯button -->
      <view class="chart-type-selector">
        <view class="type-btn {{chartType === 'line' ? 'active' : ''}}" bindtap="changeChartType" data-type="line">
          æŠ˜çº¿å›¾
        </view>
        <view class="type-btn {{chartType === 'bar' ? 'active' : ''}}" bindtap="changeChartType" data-type="bar">
          æŸ±çŠ¶å›¾
        </view>
        <view class="type-btn {{chartType === 'heatmap' ? 'active' : ''}}" bindtap="changeChartType" data-type="heatmap">
          çƒ­åŠ›å›¾
        </view>
      </view>

      <!-- EChartså›¾è¡¨å®¹å™¨ -->
      <view class="chart-container">
        <ec-canvas 
          id="demand-chart" 
          class="ec-canvas" 
          canvas-id="demand-chart" 
          ec="{{ ec }}"
          force-use-old-canvas="{{false}}"
          disable-scroll="{{false}}"
        ></ec-canvas>
      </view>

      <!-- å›¾è¡¨è¯´æ˜ -->
      <view class="chart-description">
        <text wx:if="{{chartType === 'line'}}">ğŸ“Œ 24å°æ—¶éœ€æ±‚å˜åŒ–è¶‹åŠ¿</text>
        <text wx:if="{{chartType === 'bar'}}">ğŸ“Œ å„æ—¥éœ€æ±‚é‡å¯¹æ¯”</text>
        <text wx:if="{{chartType === 'heatmap'}}">ğŸ“Œ æ—¥æœŸÃ—å°æ—¶çƒ­åŠ›åˆ†å¸ƒ</text>
      </view>
    </view>

    <!-- ç»Ÿè®¡æŒ‡æ ‡æ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'stats'}}">
      <view class="stats-grid">
        <view class="stat-card">
          <view class="stat-label">æ€»éœ€æ±‚é‡</view>
          <view class="stat-value">{{statistics.totalDemand}}</view>
          <view class="stat-unit">æ¬¡</view>
        </view>
        <view class="stat-card">
          <view class="stat-label">å¹³å‡éœ€æ±‚</view>
          <view class="stat-value">{{statistics.avgDemand}}</view>
          <view class="stat-unit">æ¬¡/å°æ—¶</view>
        </view>
        <view class="stat-card">
          <view class="stat-label">æœ€é«˜éœ€æ±‚</view>
          <view class="stat-value">{{statistics.maxDemand}}</view>
          <view class="stat-unit">æ¬¡</view>
        </view>
        <view class="stat-card">
          <view class="stat-label">æœ€ä½éœ€æ±‚</view>
          <view class="stat-value">{{statistics.minDemand}}</view>
          <view class="stat-unit">æ¬¡</view>
        </view>
      </view>

      <view class="peak-analysis">
        <view class="section-title">â° å³°å€¼æ—¶æ®µåˆ†æ</view>
        <view class="peak-item">
          <view class="peak-label">æœ€é«˜å³°æ—¶æ®µ</view>
          <view class="peak-info">
            <text class="peak-time">{{statistics.peakTime}}</text>
            <text class="peak-value">{{statistics.peakValue}}æ¬¡</text>
          </view>
        </view>
        <view class="peak-item">
          <view class="peak-label">æœ€ä½è°·æ—¶æ®µ</view>
          <view class="peak-info">
            <text class="peak-time">{{statistics.valleyTime}}</text>
            <text class="peak-value">{{statistics.valleyValue}}æ¬¡</text>
          </view>
        </view>
      </view>

      <view class="stability-analysis">
        <view class="section-title">ğŸ“‰ éœ€æ±‚ç¨³å®šæ€§</view>
        <view class="stability-item">
          <text class="label">æ ‡å‡†å·®</text>
          <text class="value">{{statistics.stdDev}}</text>
        </view>
        <view class="stability-item">
          <text class="label">å˜å¼‚ç³»æ•°</text>
          <text class="value">{{statistics.cv}}</text>
        </view>
        <view class="stability-desc">
          <text>{{statistics.stabilityDesc}}</text>
        </view>
      </view>
    </view>

    <!-- æ•°æ®è¡¨æ ¼æ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'table'}}">
      <view class="table-header">
        <text class="col-time">æ—¶é—´</text>
        <text class="col-demand">éœ€æ±‚é‡</text>
        <text class="col-status">çŠ¶æ€</text>
      </view>
      <scroll-view class="table-body" scroll-y>
        <view class="table-row" wx:for="{{tableData}}" wx:key="id">
          <text class="col-time">{{item.time}}</text>
          <text class="col-demand">{{item.demand}}</text>
          <view class="col-status">
            <text class="status-tag {{item.level}}">{{item.levelText}}</text>
          </view>
        </view>
      </scroll-view>
      
      <view class="table-footer">
        <button class="btn-export" bindtap="exportData">
          <text class="icon">ğŸ“¥</text>
          <text>å¯¼å‡ºæ•°æ®</text>
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>
