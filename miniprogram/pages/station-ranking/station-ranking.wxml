<!-- miniprogram/pages/station-ranking/station-ranking.wxml -->
<view class="container">
  <!-- æ¨¡å¼åˆ‡æ¢ -->
  <view class="mode-tabs">
    <view 
      class="mode-tab {{currentMode === 'ranking' ? 'active' : ''}}"
      bindtap="switchMode"
      data-mode="ranking">
      <text class="tab-icon">ğŸ†</text>
      <text class="tab-text">ç«™ç‚¹æ’å</text>
    </view>
    <view 
      class="mode-tab {{currentMode === 'compare' ? 'active' : ''}}"
      bindtap="switchMode"
      data-mode="compare">
      <text class="tab-icon">ğŸ“Š</text>
      <text class="tab-text">ç«™ç‚¹å¯¹æ¯”</text>
    </view>
  </view>

  <!-- æ’åæ¨¡å¼ -->
  <block wx:if="{{currentMode === 'ranking'}}">
    <!-- æ’åç±»å‹é€‰æ‹© - ä¼˜åŒ–å¸ƒå±€ä¸ºä¸¤è¡Œ -->
    <view class="ranking-types">
      <view class="section-title-inline">
        <text class="title-icon">ğŸ“‹</text>
        <text class="title-text">é€‰æ‹©æŒ‡æ ‡</text>
      </view>
      
      <view class="type-grid">
        <!-- ç¬¬ä¸€è¡Œï¼š3ä¸ªé€‰é¡¹ -->
        <view class="type-row">
          <view 
            class="type-item {{rankingType === 'total' ? 'active' : ''}}"
            bindtap="changeRankingType"
            data-type="total">
            <text class="type-icon">ğŸ“ˆ</text>
            <text class="type-name">æ€»éœ€æ±‚</text>
          </view>
          <view 
            class="type-item {{rankingType === 'avg' ? 'active' : ''}}"
            bindtap="changeRankingType"
            data-type="avg">
            <text class="type-icon">ğŸ“Š</text>
            <text class="type-name">å¹³å‡éœ€æ±‚</text>
          </view>
          <view 
            class="type-item {{rankingType === 'peak' ? 'active' : ''}}"
            bindtap="changeRankingType"
            data-type="peak">
            <text class="type-icon">âš¡</text>
            <text class="type-name">å³°å€¼éœ€æ±‚</text>
          </view>
        </view>
        
        <!-- ç¬¬äºŒè¡Œï¼š2ä¸ªé€‰é¡¹ -->
        <!-- <view class="type-row">
          <view 
            class="type-item {{rankingType === 'growth' ? 'active' : ''}}"
            bindtap="changeRankingType"
            data-type="growth">
            <text class="type-icon">ğŸ“ˆ</text>
            <text class="type-name">å¢é•¿ç‡</text>
          </view>
          <view 
            class="type-item {{rankingType === 'stability' ? 'active' : ''}}"
            bindtap="changeRankingType"
            data-type="stability">
            <text class="type-icon">ğŸ¯</text>
            <text class="type-name">ç¨³å®šæ€§</text>
          </view>
        </view> -->
      </view>
    </view>

    <!-- Top 10 æ’è¡Œæ¦œ -->
    <view class="ranking-section">
      <view class="section-title">
        <text class="title-icon">ğŸ†</text>
        <text class="title-text">Top 10 æ’è¡Œæ¦œ</text>
      </view>

      <view class="ranking-list">
        <block wx:for="{{showFullList ? rankingList : rankingList.slice(0, 10)}}" wx:key="stationId">
          <view class="ranking-item" bindtap="viewStationDetail" data-id="{{item.stationId}}">
            <!-- æ’å -->
            <view class="rank-badge {{item.rank <= 3 ? 'top-three' : ''}}">
              <text class="rank-text" wx:if="{{item.rank <= 3}}">{{item.rank === 1 ? 'ğŸ¥‡' : item.rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}}</text>
              <text class="rank-number" wx:else>{{item.rank}}</text>
            </view>

            <!-- ç«™ç‚¹ä¿¡æ¯ -->
            <view class="station-info">
              <view class="station-name">{{item.name}}</view>
              <view class="station-id">ID: {{item.stationId}}</view>
            </view>

            <!-- æŒ‡æ ‡å€¼ -->
            <view class="metric-value">
              <block wx:if="{{rankingType === 'total'}}">
                <text class="value-number">{{item.totalDemandDisplay}}</text>
                <text class="value-unit">æ¬¡</text>
              </block>
              <block wx:elif="{{rankingType === 'avg'}}">
                <text class="value-number">{{item.avgDemandDisplay}}</text>
                <text class="value-unit">æ¬¡/å°æ—¶</text>
              </block>
              <block wx:elif="{{rankingType === 'peak'}}">
                <text class="value-number">{{item.maxDemand}}</text>
                <text class="value-unit">æ¬¡</text>
              </block>
              <block wx:elif="{{rankingType === 'growth'}}">
                <text class="value-number {{item.growthRate >= 0 ? 'positive' : 'negative'}}">
                  {{item.growthRateDisplay}}
                </text>
              </block>
              <block wx:else>
                <text class="value-number">{{item.stabilityDisplay}}</text>
                <text class="value-unit">åˆ†</text>
              </block>
            </view>

            <!-- è¿›åº¦æ¡ -->
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{item.progressWidth}}"></view>
            </view>
          </view>
        </block>
      </view>

      <!-- æŸ¥çœ‹å®Œæ•´æ¦œå•æŒ‰é’® -->
      <view class="toggle-list-btn" bindtap="toggleFullList" wx:if="{{rankingList.length > 10}}">
        <text>{{showFullList ? 'æ”¶èµ·' : 'æŸ¥çœ‹å®Œæ•´æ¦œå•'}}</text>
        <text class="arrow {{showFullList ? 'up' : 'down'}}">â–¼</text>
      </view>
    </view>
  </block>

  <!-- å¯¹æ¯”æ¨¡å¼ -->
  <block wx:if="{{currentMode === 'compare'}}">
    <!-- ç«™ç‚¹é€‰æ‹©åŒº -->
    <view class="compare-section">
      <view class="section-title">
        <text class="title-icon">ğŸ“</text>
        <text class="title-text">é€‰æ‹©ç«™ç‚¹</text>
        <text class="title-subtitle">æœ€å¤š5ä¸ª</text>
      </view>

      <view class="selected-stations">
        <block wx:for="{{selectedStations}}" wx:key="stationId" wx:for-index="idx">
          <view class="selected-station station-color-{{idx % 5}}">
            <text class="station-name">{{item.name}}</text>
            <text class="remove-btn" bindtap="removeStation" data-id="{{item.stationId}}">Ã—</text>
          </view>
        </block>

        <view class="add-station-btn" bindtap="openStationPicker" wx:if="{{selectedStations.length < 5}}">
          <text class="add-icon">+</text>
          <text class="add-text">æ·»åŠ ç«™ç‚¹</text>
        </view>
      </view>

      <!-- æç¤ºä¿¡æ¯ -->
      <view class="compare-hint" wx:if="{{selectedStations.length < 2}}">
        <text class="hint-icon">ğŸ’¡</text>
        <text class="hint-text">è¯·è‡³å°‘é€‰æ‹©2ä¸ªç«™ç‚¹è¿›è¡Œå¯¹æ¯”</text>
      </view>
    </view>

    <!-- å¯¹æ¯”å›¾è¡¨ -->
    <view class="chart-section" style="width: 100%; box-sizing: border-box;" wx:if="{{selectedStations.length >= 2 && compareData && !showStationPicker}}">
      <view class="section-title">
        <text class="title-icon">ğŸ“Š</text>
        <text class="title-text">å¤šç»´åº¦å¯¹æ¯”</text>
      </view>

      <view class="chart-container" style="width: 100%; box-sizing: border-box;">
        <ec-canvas 
          id="compare-chart" 
          canvas-id="compare-chart" 
          ec="{{ ec }}"
          style="width: 100%; height: 100%; box-sizing: border-box;"></ec-canvas>
      </view>
    </view>

    <!-- å¯¹æ¯”è¡¨æ ¼ -->
    <view class="compare-table-section" wx:if="{{selectedStations.length >= 2 && compareData && !showStationPicker}}">
      <view class="section-title">
        <text class="title-icon">ğŸ“‹</text>
        <text class="title-text">è¯¦ç»†æ•°æ®å¯¹æ¯”</text>
      </view>

      <scroll-view scroll-x class="table-scroll" enable-flex>
        <view class="compare-table">
          <!-- è¡¨å¤´ -->
          <view class="table-header">
            <view class="table-cell header-cell">æŒ‡æ ‡</view>
            <block wx:for="{{selectedStations}}" wx:key="stationId" wx:for-index="idx">
              <view class="table-cell header-cell station-header station-color-{{idx % 5}}">
                {{item.name}}
              </view>
            </block>
          </view>

          <!-- æ•°æ®è¡Œ -->
          <view class="table-body">
            <!-- æ€»éœ€æ±‚ -->
            <view class="table-row">
              <view class="table-cell label-cell">
                <text class="label-icon">ğŸ“ˆ</text>
                <text class="label-text">æ€»éœ€æ±‚</text>
              </view>
              <block wx:for="{{selectedStations}}" wx:key="stationId">
                <view class="table-cell data-cell">
                  {{compareData[item.stationId].totalDemandDisplay}}
                </view>
              </block>
            </view>

            <!-- å¹³å‡éœ€æ±‚ -->
            <view class="table-row">
              <view class="table-cell label-cell">
                <text class="label-icon">ğŸ“Š</text>
                <text class="label-text">å¹³å‡éœ€æ±‚</text>
              </view>
              <block wx:for="{{selectedStations}}" wx:key="stationId">
                <view class="table-cell data-cell">
                  {{compareData[item.stationId].avgDemandDisplay}}
                </view>
              </block>
            </view>

            <!-- å³°å€¼éœ€æ±‚ -->
            <view class="table-row">
              <view class="table-cell label-cell">
                <text class="label-icon">âš¡</text>
                <text class="label-text">å³°å€¼éœ€æ±‚</text>
              </view>
              <block wx:for="{{selectedStations}}" wx:key="stationId">
                <view class="table-cell data-cell">
                  {{compareData[item.stationId].maxDemand}}
                </view>
              </block>
            </view>

            <!-- å¢é•¿ç‡ -->
            <!-- <view class="table-row">
              <view class="table-cell label-cell">
                <text class="label-icon">ğŸ“ˆ</text>
                <text class="label-text">å¢é•¿ç‡</text>
              </view>
              <block wx:for="{{selectedStations}}" wx:key="stationId">
                <view class="table-cell data-cell">
                  <text class="{{compareData[item.stationId].growthRate >= 0 ? 'positive' : 'negative'}}">
                    {{compareData[item.stationId].growthRateDisplay}}
                  </text>
                </view>
              </block>
            </view> -->

            <!-- ç¨³å®šæ€§ -->
            <!-- <view class="table-row">
              <view class="table-cell label-cell">
                <text class="label-icon">ğŸ¯</text>
                <text class="label-text">ç¨³å®šæ€§</text>
              </view>
              <block wx:for="{{selectedStations}}" wx:key="stationId">
                <view class="table-cell data-cell">
                  {{compareData[item.stationId].stabilityDisplay}}
                </view>
              </block>
            </view> -->

            <!-- å·¥ä½œæ—¥éœ€æ±‚ -->
            <view class="table-row">
              <view class="table-cell label-cell">
                <text class="label-icon">ğŸ¢</text>
                <text class="label-text">å·¥ä½œæ—¥</text>
              </view>
              <block wx:for="{{selectedStations}}" wx:key="stationId">
                <view class="table-cell data-cell">
                  {{compareData[item.stationId].weekdayAvgDisplay}}
                </view>
              </block>
            </view>

            <!-- å‘¨æœ«éœ€æ±‚ -->
            <view class="table-row">
              <view class="table-cell label-cell">
                <text class="label-icon">ğŸ‰</text>
                <text class="label-text">å‘¨æœ«</text>
              </view>
              <block wx:for="{{selectedStations}}" wx:key="stationId">
                <view class="table-cell data-cell">
                  {{compareData[item.stationId].weekendAvgDisplay}}
                </view>
              </block>
            </view>

            <!-- å˜å¼‚ç³»æ•° - å·²åˆ é™¤ -->
          </view>
        </view>
      </scroll-view>
    </view>
  </block>

  <!-- ç«™ç‚¹é€‰æ‹©å¼¹çª— -->
  <view class="station-picker-modal" wx:if="{{showStationPicker}}">
    <view class="modal-mask" bindtap="closeStationPicker"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©ç«™ç‚¹</text>
        <text class="modal-close" bindtap="closeStationPicker">Ã—</text>
      </view>
      
      <scroll-view scroll-y class="station-list">
        <block wx:for="{{stationList}}" wx:key="stationId">
          <view 
            class="station-item {{item.isSelected ? 'selected' : ''}}"
            bindtap="selectStation"
            data-id="{{item.stationId}}">
            <view class="station-item-content">
              <text class="station-name">{{item.name}}</text>
              <text class="station-id">ID: {{item.stationId}}</text>
            </view>
            <text class="check-icon" wx:if="{{item.isSelected}}">âœ“</text>
          </view>
        </block>
      </scroll-view>
    </view>
  </view>
</view>
